<!DOCTYPE html>
<html lang="en">
<head>
  <title>Kurs Robot Framework</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
  <script src="presentation.js"></script>
</head>
<style>
#pr_indicator {
	position: absolute;
	left: 0%;
	width: 2px;
	height: 100%;
	background-color: black;
}
#pr_elapsed_part {
	position: absolute;
	opacity: 0.7;
	width: 0%;
	height: 100%;
	background-color: #cccccc;
}
.progress {
	position: relative;
	height: 30px !important;
}
.progress-bar {
	padding: 5px;
	font-weight: bold;
	font-size: 14px;
}
#wrong_time_warning {
	display: none;
}
#wrong_mod_time_warning {
	display: none;
}
#pr_elapsed_time {
	display: none;
}
#mod_indicator {
	position: absolute;
	left: 0%;
	width: 2px;
	height: 100%;
	background-color: black;
}
#mod_elapsed_part {
	position: absolute;
	opacity: 0.7;
	width: 0%;
	height: 100%;
	background-color: #cccccc;
}
</style>
<script>
$(document).ready(function() {

	update_labels();
	create_progress_bars();
	var start_times = get_modules_start_times();

	function get_modules_start_times(){
		let starting_time = 0;
		let start_times = [];
		let modules_time_sum = 0;
		for (module of data.presentation.modules){
			start_times.push(starting_time)
			starting_time += module.time / data.presentation.duration * 100;
			modules_time_sum += module.time;
			
			if (module.type != 'break') {
				var topics_time_sum = 0;
				for (topic of module.topics) {
					topics_time_sum += topic.time;
				}
				if (topics_time_sum != module.time) {
					$('#wrong_mod_time_warning').css('display', 'block').text(`Uwaga! Suma czasu tematów z modułu '${module.label}' jest różna od czasu trwania modułu`);
				}
			}
		}
		if (modules_time_sum != data.presentation.duration){
			$('#wrong_time_warning').css('display', 'block');
		}
		return start_times;
	}

	function update_labels(){
		$('#pr_title').text(data.presentation.title);
		$('#pr_subtitle').text(data.presentation.subtitle);
		$('#pr_duration').text("Długość trwania: " + data.presentation.duration);
		let pr_date = new Date(data.presentation.date).toLocaleDateString('pl-PL', {  
			day : 'numeric',
			month : 'long',
			year : 'numeric',
			hour: '2-digit',
			minute: '2-digit'
		});
		$('#pr_time').text("Termin: " + pr_date);
	}
	
	function create_progress_bars(){
		let first = true;
		for (module of data.presentation.modules){
			modul_div = $('<div/>', {
				class: 'progress-bar',
				text: module.label + " ",
				style: `width:${module.time / data.presentation.duration * 100}%; background-color:${module.color} !important;`
			});
			badge = $('<span/>', {
				class: 'badge',
				text: module.time + " min"
			});
			modul_div.append(badge);
			modul_div.appendTo('#progress_parent');
			
			if (first) {
				first = false;
				update_mod_progress_bar(module);
				$('#current_module_label').text("Bieżący moduł: " + module.label);
			}
		}
	}
	
	function create_break_progress_bar(module){
		break_div = $('<div/>', {
			class: 'progress-bar',
			text: module.label + " ",
			style: `width:${module.time / module.time * 100}%; background-color: #cccccc !important;`
		});
		break_div.appendTo('#mod_progress');
	}
	
	function create_mod_progress_bars(module){
		for (topic of module.topics){
			topic_div = $('<div/>', {
				class: 'progress-bar',
				text: topic.label + " ",
				style: `width:${topic.time / module.time * 100}%; background-color:${getRandomColor(module.color)} !important;`
			});
			badge = $('<span/>', {
				class: 'badge',
				text: topic.time + " min"
			});
			topic_div.append(badge);
			topic_div.appendTo('#mod_progress');
		}
	}
	
	function update_mod_progress_bar(module) {
		$('#mod_progress').children('.progress-bar').remove();
		
		if (module.type == "break") {
			create_break_progress_bar(module);
		}
		else {
			create_mod_progress_bars(module);
		}
	}
	
	function get_current_module(progress, start_times){
		let current_module = null;
		for (var i = 0; i < start_times.length; i++){
			if (progress >= start_times[i]){
				current_module = data.presentation.modules[i];
			}
			else {
				break;
			}
		}
		return current_module;
	}

	function calculate_progress(elapsed_time, duration) {
		let duration_ms = duration * 60 * 1000;
		let progress = (elapsed_time / duration_ms * 100);
		return progress;
	}
	
	function update_elapsed_time(elapsed_time) {
		let pr_elapsed_time = new Date(0);
		pr_elapsed_time.setMilliseconds(elapsed_time - (60 * 60 * 1000));
		iso_elapsed_time = pr_elapsed_time.toISOString();
		let formattedTime = pr_elapsed_time.getHours() > 0 ? iso_elapsed_time.substr(11, 8) : iso_elapsed_time.substr(14, 5);
		$('#pr_elapsed_time').css('display', 'block').text(formattedTime);
	}
	
	function getRandomColor(color) {
		var p = 1,
			temp,
			random = Math.random(),
			result = '#';

		while (p < color.length) {
			temp = parseInt(color.slice(p, p += 2), 16)
			temp += Math.floor((255 - temp) * random);
			result += temp.toString(16).padStart(2, '0');
		}
		return result;
	}

	var start = null;
	var last_module = null;
	var elapsed_modules = 0;
	
	function step(timestamp) {
		if (!start) start = timestamp;
		let elapsed_time = timestamp - start;
		
		let pr_progress_percentage = calculate_progress(elapsed_time, data.presentation.duration);
		$('#pr_indicator').css('left', `${pr_progress_percentage}%`);
		$('#pr_elapsed_part').css('width', `${pr_progress_percentage}%`);
		
		current_module = get_current_module(pr_progress_percentage, start_times);

		if (last_module && (current_module != last_module)) {
			update_mod_progress_bar(current_module);
			$('#current_module_label').text("Bieżący moduł: " + current_module.label);
			elapsed_modules += last_module.time * 60 * 1000;
		}
		let mod_progress = elapsed_time - elapsed_modules;
		
		let mod_progress_percentage = calculate_progress(mod_progress, current_module.time);
		$('#mod_indicator').css('left', `${mod_progress_percentage}%`);
		$('#mod_elapsed_part').css('width', `${mod_progress_percentage}%`);

		update_elapsed_time(elapsed_time);
		
		let pr_duration_ms = data.presentation.duration * 60 * 1000
		if (elapsed_time < pr_duration_ms) window.requestAnimationFrame(step);
		
		last_module = current_module;
	};
	
	$('#start_button').click(function() {
		window.requestAnimationFrame(step);
	});
});

// startowanie i pauzowanie czasu
// poprawienie labeli modułów (większe, wyraźne)

</script>
<body>

<div class="container">
	<div id="wrong_time_warning" class="alert alert-warning">
		<strong>Uwaga!</strong> Suma czasu wszystkich modułów jest różna od czasu trwania kursu
	</div>
	
	<div id="wrong_mod_time_warning" class="alert alert-warning"></div>

	<h2 id="pr_title">Title</h2>
	
	<p id="pr_subtitle">Subtitle</p>
	
	<p id="pr_duration">Presentation duration</p>
	
	<p id="pr_time">Presentation date</p>
	
	<div class="row">
		<div class="col-lg-2">
			<button id="start_button" type="button" class="btn btn-success">Start</button>
		</div>
		<div class="col-lg-10">
			<span id="pr_elapsed_time"></span>
		</div>
	</div>

	<h3 id="current_module_label">Current module</h3>
	
	<div id="progress_parent" class="progress">
		<div id="pr_indicator"></div>
		<div id="pr_elapsed_part"></div>
	</div>
	
	<div id="mod_progress" class="progress">
		<div id="mod_indicator"></div>
		<div id="mod_elapsed_part"></div>
	</div>
</div>

</body>
</html>
