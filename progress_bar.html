<!DOCTYPE html>
<html lang="en">
<head>
  <title>Kurs Robot Framework</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
  <script src="presentation.js"></script>
</head>
<style>
#pr_indicator {
	position: absolute;
	left: 0%;
	width: 2px;
	height: 100%;
	background-color: black;
}
#pr_elapsed_part {
	position: absolute;
	opacity: 0.7;
	width: 0%;
	height: 100%;
	background-color: #cccccc;
}
.progress {
	position: relative;
	height: 30px !important;
}
.progress-bar {
	padding: 5px;
	font-weight: bold;
	font-size: 14px;
}
#wrong_time_warning {
	display: none;
}
#pr_elapsed_time {
	display: none;
}
#mod_indicator {
	position: absolute;
	left: 0%;
	width: 2px;
	height: 100%;
	background-color: black;
}
#mod_elapsed_part {
	position: absolute;
	opacity: 0.7;
	width: 0%;
	height: 100%;
	background-color: #cccccc;
}
</style>
<script>
$(document).ready(function() {

	update_labels();
	create_progress_bars();
	var start_times = get_modules_start_times();

	function get_modules_start_times(){
		let starting_time = 0;
		let start_times = [];
		let modules_time_sum = 0;
		for (module of data.presentation.modules){
			start_times.push(starting_time)
			starting_time += module.time / data.presentation.duration * 100;
			modules_time_sum += module.time;
		}
		if (modules_time_sum != data.presentation.duration){
			$('#wrong_time_warning').css('display', 'block');
		}
		return start_times;
	}

	function update_labels(){
		$('#pr_title').text(data.presentation.title);
		$('#pr_subtitle').text(data.presentation.subtitle);
		$('#pr_duration').text("Długość trwania: " + data.presentation.duration);
		let pr_date = new Date(data.presentation.date).toLocaleDateString('pl-PL', {  
			day : 'numeric',
			month : 'long',
			year : 'numeric',
			hour: '2-digit',
			minute: '2-digit'
		});
		$('#pr_time').text("Termin: " + pr_date);
	}
	
	function create_progress_bars(){
		let first = true;
		for (module of data.presentation.modules){
			modul_div = $('<div/>', {
				class: 'progress-bar',
				text: module.label + " ",
				style: `width:${module.time / data.presentation.duration * 100}%; background-color:${module.color} !important;`
			});
			badge = $('<span/>', {
				class: 'badge',
				text: module.time + " min"
			});
			modul_div.append(badge);
			modul_div.appendTo('#progress_parent');
			
			if (first) {
				first = false;
				update_mod_progress_bar(module);
			}
		}
	}
	
	function get_current_module(progress, start_times){
		let current_module = null;
		for (var i = 0; i < start_times.length; i++){
			if (progress >= start_times[i]){
				current_module = data.presentation.modules[i];
			}
			else {
				break;
			}
		}
		return current_module;
	}
	
	function update_mod_progress_bar(module) {
		$('#mod_progress_bar').css('background-color', `${module.color}`).text(module.label);
		$('#mod_badge').text(module.time + " min")	
	}

	var start = null;
	var pr_time = data.presentation.duration * 60 * 1000;  // duration in ms
	var elapsed_modules = 0;
	var last_module = null;

	function step(timestamp) {
		if (!start) start = timestamp;
		let progress = timestamp - start;
		let presentation_progress = (progress / pr_time * 100);
		$('#pr_indicator').css('left', `${presentation_progress}%`);
		$('#pr_elapsed_part').css('width', `${presentation_progress}%`);
		
		current_module = get_current_module(presentation_progress, start_times);
		
		if (last_module && (current_module != last_module)) {
			update_mod_progress_bar(current_module);
			elapsed_modules += last_module.time * 60 * 1000;
			console.log(elapsed_modules);
		}
		let mod_progress = progress - elapsed_modules;
		mod_duration = current_module.time * 60 * 1000;
		let mod_progress_percent = (mod_progress / mod_duration * 100);
		$('#mod_indicator').css('left', `${mod_progress_percent}%`);
		$('#mod_elapsed_part').css('width', `${mod_progress_percent}%`);

		$('#current_module_label').text("Bieżący moduł: " + current_module.label);
		
		let elapsed_time = new Date(0);
		elapsed_time.setMilliseconds(progress - (60 * 60 * 1000));
		iso_elapsed_time = elapsed_time.toISOString();
		let formattedTime = elapsed_time.getHours() > 0 ? iso_elapsed_time.substr(11, 8) : iso_elapsed_time.substr(14, 5);

		$('#pr_elapsed_time').css('display', 'block').text(formattedTime);
		
		if (progress < pr_time) window.requestAnimationFrame(step);
		
		last_module = current_module;
	};
	
	$('#start_button').click(function() {
		window.requestAnimationFrame(step);
		
	});
});

// startowanie i pauzowanie czasu
// 2 progress bary: 1. od całego kursu, 2. od konkretnego modułu (dodanie do jsona modułów podzielonych na konkretne tematy)
// kolory tematów w modułach powinny mieć podobne kolory co moduł https://stackoverflow.com/questions/46681852/javascript-generate-similar-random-color-shader-tint-monochromatic
// nazwa bieżącego modułu powinna być w jego kolorze
// dodanie linii podziału (w szarym kolorze) na modułach w widoku całego kursu w miejscach, gdzie rozpoczynają się kolejne tematy
// poprawienie labeli modułów (większe, wyraźne)
</script>
<body>

<div class="container">
	<div id="wrong_time_warning" class="alert alert-warning">
		<strong>Uwaga!</strong> Suma czasu wszystkich modułów jest różna od czasu trwania kursu
	</div>

	<h2 id="pr_title">Title</h2>
	
	<p id="pr_subtitle">Subtitle</p>
	
	<p id="pr_duration">Presentation duration</p>
	
	<p id="pr_time">Presentation date</p>
	
	<div class="row">
		<div class="col-lg-2">
			<button id="start_button" type="button" class="btn btn-success">Start</button>
		</div>
		<div class="col-lg-10">
			<span id="pr_elapsed_time"></span>
		</div>
	</div>

	<h3 id="current_module_label">Current module</h3>
	
	<div id="progress_parent" class="progress">
		<div id="pr_indicator"></div>
		<div id="pr_elapsed_part"></div>
	</div>
	
	<div id="mod_progress" class="progress">
		<div id="mod_progress_bar" class="progress-bar" style="width: 100%">
			<span id="mod_badge" class="badge">0 min</span>
		</div>
		<div id="mod_indicator"></div>
		<div id="mod_elapsed_part"></div>
	</div>
</div>

</body>
</html>
